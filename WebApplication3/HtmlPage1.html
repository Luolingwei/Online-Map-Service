<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <title>OpenLayers</title>

    <link rel="stylesheet" href="./ol.css" type="text/css" />

    <script src="./ol.js" type="text/javascript"></script>
    <script src="jquery-3.2.1.js" type="text/javascript"></script>
    <script src="echarts.js" type="text/javascript"></script>

</head>

<style>
    #map {
        width: 100%;
        height: 100%;
        position: absolute;
        z-index: -200;
    }

    #txt {
        position: absolute;
        left: 130px;
        top: 50px;
        border: 1px solid #ccc;
        padding: 4px 0px;
        border-radius: 10px;
        padding-left: 5px;
    }

    #btn1 {
        position: absolute;
        left: 310px;
        top: 50px;
        color: #8c96a0;
        text-shadow: 1px 1px 1px #fff;
        border: 1px solid #dce1e6;
        box-shadow: 0 1px 2px #fff inset,0 -1px 0 #a8abae inset;
        background: -webkit-linear-gradient(top,#f2f3f7,#e4e8ec);
        background: -moz-linear-gradient(top,#f2f3f7,#e4e8ec);
        background: linear-gradient(top,#f2f3f7,#e4e8ec);
    }

    #btn2 {
        position: absolute;
        right: 50px;
        top: 50px;
        color: #8c96a0;
        text-shadow: 1px 1px 1px #fff;
        border: 1px solid #dce1e6;
        box-shadow: 0 1px 2px #fff inset,0 -1px 0 #a8abae inset;
        background: -webkit-linear-gradient(top,#f2f3f7,#e4e8ec);
        background: -moz-linear-gradient(top,#f2f3f7,#e4e8ec);
        background: linear-gradient(top,#f2f3f7,#e4e8ec);
    }

    #btn3 {
        position: absolute;
        right: 50px;
        top: 100px;
        color: #8c96a0;
        text-shadow: 1px 1px 1px #fff;
        border: 1px solid #dce1e6;
        box-shadow: 0 1px 2px #fff inset,0 -1px 0 #a8abae inset;
        background: -webkit-linear-gradient(top,#f2f3f7,#e4e8ec);
        background: -moz-linear-gradient(top,#f2f3f7,#e4e8ec);
        background: linear-gradient(top,#f2f3f7,#e4e8ec);
    }

    #btn4 {
        position: absolute;
        right: 50px;
        top: 150px;
        color: #8c96a0;
        text-shadow: 1px 1px 1px #fff;
        border: 1px solid #dce1e6;
        box-shadow: 0 1px 2px #fff inset,0 -1px 0 #a8abae inset;
        background: -webkit-linear-gradient(top,#f2f3f7,#e4e8ec);
        background: -moz-linear-gradient(top,#f2f3f7,#e4e8ec);
        background: linear-gradient(top,#f2f3f7,#e4e8ec);
    }

    #btn5 {
        position: absolute;
        right: 50px;
        top: 200px;
        color: #8c96a0;
        text-shadow: 1px 1px 1px #fff;
        border: 1px solid #dce1e6;
        box-shadow: 0 1px 2px #fff inset,0 -1px 0 #a8abae inset;
        background: -webkit-linear-gradient(top,#f2f3f7,#e4e8ec);
        background: -moz-linear-gradient(top,#f2f3f7,#e4e8ec);
        background: linear-gradient(top,#f2f3f7,#e4e8ec);
    }

    #btn6 {
        position: absolute;
        right: 50px;
        top: 250px;
        color: #8c96a0;
        text-shadow: 1px 1px 1px #fff;
        border: 1px solid #dce1e6;
        box-shadow: 0 1px 2px #fff inset,0 -1px 0 #a8abae inset;
        background: -webkit-linear-gradient(top,#f2f3f7,#e4e8ec);
        background: -moz-linear-gradient(top,#f2f3f7,#e4e8ec);
        background: linear-gradient(top,#f2f3f7,#e4e8ec);
    }

    #btn7 {
        position: absolute;
        right: 50px;
        top: 300px;
        color: #8c96a0;
        text-shadow: 1px 1px 1px #fff;
        border: 1px solid #dce1e6;
        box-shadow: 0 1px 2px #fff inset,0 -1px 0 #a8abae inset;
        background: -webkit-linear-gradient(top,#f2f3f7,#e4e8ec);
        background: -moz-linear-gradient(top,#f2f3f7,#e4e8ec);
        background: linear-gradient(top,#f2f3f7,#e4e8ec);
    }

    #btn8 {
        position: absolute;
        right: 50px;
        top: 350px;
        color: #8c96a0;
        text-shadow: 1px 1px 1px #fff;
        border: 1px solid #dce1e6;
        box-shadow: 0 1px 2px #fff inset,0 -1px 0 #a8abae inset;
        background: -webkit-linear-gradient(top,#f2f3f7,#e4e8ec);
        background: -moz-linear-gradient(top,#f2f3f7,#e4e8ec);
        background: linear-gradient(top,#f2f3f7,#e4e8ec);
    }

    #example{
        position: absolute;
        right: 150px;
        top:300px;
        color: #8c96a0;
        text-shadow: 1px 1px 1px #fff;
        border: 1px solid #dce1e6;
        box-shadow: 0 1px 2px #fff inset,0 -1px 0 #a8abae inset;
        background: -webkit-linear-gradient(top,#f2f3f7,#e4e8ec);
        background: -moz-linear-gradient(top,#f2f3f7,#e4e8ec);
        background: linear-gradient(top,#f2f3f7,#e4e8ec);
    }  

    #sure{
        position: absolute;
        left: 160px;
        bottom:50px;
        color: #8c96a0;
        text-shadow: 1px 1px 1px #fff;
        border: 1px solid #dce1e6;
        box-shadow: 0 1px 2px #fff inset,0 -1px 0 #a8abae inset;
        background: -webkit-linear-gradient(top,#f2f3f7,#e4e8ec);
        background: -moz-linear-gradient(top,#f2f3f7,#e4e8ec);
        background: linear-gradient(top,#f2f3f7,#e4e8ec);
        z-index:-300;
    } 

    #exportmap{
        position: absolute;
        right: 150px;
        top:350px;
        color: #8c96a0;
        text-shadow: 1px 1px 1px #fff;
        border: 1px solid #dce1e6;
        box-shadow: 0 1px 2px #fff inset,0 -1px 0 #a8abae inset;
        background: -webkit-linear-gradient(top,#f2f3f7,#e4e8ec);
        background: -moz-linear-gradient(top,#f2f3f7,#e4e8ec);
        background: linear-gradient(top,#f2f3f7,#e4e8ec);
    }

    #huizhi {
        position: absolute;
        right: 900px;
        top: 50px;
    }

    #xiugai {
        position: absolute;
        right: 700px;
        top: 50px;
    }

    #dianxuan {
        position: absolute;
        right: 500px;
        top: 50px;
    }

    #tucengkongzhi {
        position: absolute;
        right: 200px;
        top: 50px;
    }

    #overview {
        background-color: #fff;
        width: 290px;
        height: 290px;
        margin: 3px 3px 3px 3px;
        border: 1px solid#7b98bc;
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 100;
    }

    /** {
        margin: 0;
        padding: 0;
    }*/

    /*html {
        height: 100%;
    }*/

    p {
        padding: 10px 0;
    }

    body {
        min-height: 100%;
        font-family: arial;
        /*position: relative;*/
    }

    body.sideMenu {
        margin: 0;
        -webkit-transform: none;
        transform: none;
    }

    #sideToggle {
        display: none;
    }

    #sideToggle:checked + aside {
        left: 0;
    }

    #sideToggle:checked ~ #wrap {
        padding-left: 220px;
    }

    body > aside {
        position: absolute;
        top: 0;
        bottom: 0;
        left: -200px;
        width: 200px;
        background: #DEDEDE;
        transition: 0.2s ease-out;
        -webkit-transition: 0.2s ease-out;
        z-index: 100;
    }

    body > aside > h2 {
        color: #303030;
        text-align: center;
        font-weight: normal;
        padding: 10px;
        font-size:18px;
    }

    #wrap {
        margin-left: 20px;
        padding: 10px;
        transition: 0.25s ease-out;
        -webkit-transition: 0.25s ease-out;
        position: absolute;
        z-index: 100;
    }

    #wrap > label {
        display: inline-block;
    }

    #wrap > label {
        background: #f1103a;
        border-radius: 50px;
        color: #FFE4B5;
        cursor: pointer;
        display: block;
        font-family: Courier New;
        font-size: 25px;
        font-weight: bold;
        width: 30px;
        height: 30px;
        line-height: 35px;
        text-align: center;
        text-shadow: 0 -4px;
        position: absolute;
        z-index: 100;
    }

    #wrap > label:hover {
        background: #000;
    }

    #float {
        position: fixed;
        top: 100px;
        width: 1000px;
        left: 200px;
        height: 500px;
        line-height: 500px;
        text-align: center;
        border: 1px solid #000;
        background-color: #FFF;
    }

    #cityname{
        position: absolute;
        border: 1px solid #ccc;
        padding: 4px 0px;
        border-radius: 10px;
        padding-left: 5px;
        z-index:-300;
        bottom:200px;
        left:100px;
    }

    #citypinyin{
        position: absolute;
        border: 1px solid #ccc;
        padding: 4px 0px;
        border-radius: 10px;
        padding-left: 5px;
        z-index:-300;
        bottom:150px;
        left:100px;
    }

    #cityclass{
        position: absolute;        
        border: 1px solid #ccc;
        padding: 4px 0px;
        border-radius: 10px;
        padding-left: 5px;
        z-index:-300;
        bottom:100px;
        left:100px;
    }

    #information{
        background-color:gray;
        z-index:300;
    }

</style>



<body>
    
    <input type='checkbox' id='sideToggle' />
    <aside><h2>操作</h2></aside>
    <div id='wrap'>
        <label id='sideMenuControl' for='sideToggle'>=</label>
    </div>

    <div id="mybutton">
        <button id="btn1" onclick="btn1_click()">查询</button>
        <button id="btn2" onclick="moveToTop()">上移</button>
        <button id="btn3" onclick="moveToBottom()">下移</button>
        <button id="btn4" onclick="moveToLeft()">左移</button>
        <button id="btn5" onclick="moveToRight()">右移</button>
        <button id="btn6" onclick="zoomIn()">放大</button>
        <button id="btn7" onclick="zoomOut()">缩小</button>
        <button id="btn8" onclick="measureBtn()">量测</button>
        <button id="example" onclick="query_chart()">统计图表</button>       
        <button id="exportmap" onclick="exportmap()">导出地图</button>
    </div>         
        
    <div id="information">
        <div id="tip" style="left: 70px; position:absolute; bottom: 250px;margin:0.67em 0; font-size:0.8em;z-index:-300;color:red;">Please input cityname, citypinyin, cityclass</div>
        <div>
            <input id="cityname" />
            <input id="citypinyin" />
            <input id="cityclass" />
        </div>
        <button id="sure" onclick="inputvar()">确定</button>
    </div>
   
    <div style="right: 1000px; position:absolute; top: 48px;">添加</div>
    <select id="huizhi">
        <option value="None">None</option>
        <option value="Point">Point</option>
        <option value="LineString">LineString</option>
        <option value="Polygon">Polygon</option>
        <option value="Circle">Circle</option>
    </select>

    <div style="right: 800px; position:absolute; top: 48px;">修改</div>
    <select id="xiugai">
        <option value="None">None</option>
        <option value="Point">Point</option>
        <option value="LineString">LineString</option>
        <option value="Polygon">Polygon</option>
        <option value="Circle">Circle</option>
    </select>

    <div style="right: 600px; position:absolute; top: 48px;">删除</div>
    <select id="dianxuan" class="form-control">
        <option value="None">None</option>
        <option value="singleclick">Single-click</option>
        <option value="pointermove">Hover</option>
    </select>
   
    <div style="right: 300px; position:absolute; top: 48px;">图层控制</div>
    <select id="tucengkongzhi">
        <option value="All">全部图层</option>
        <option value="Base">底图</option>
        <option value="ImageMap">居民地地图</option>
        <option value="ImageData">居民地数据</option>      
        <option value="Remove">移除数据</option>  
    </select>

    <div id="chart"></div>

    <div id="float" style="display:none">

        <div id="mainchart" style="width:1000px;height:400px;"></div>

    </div>


    <div style="right: 1050px; position:fixed; bottom:0px; font-size:14px;">Copyright © 2017 LUO Lingwei. All rights reserved.</div>
    
    <div style="left: 70px; position:absolute; top: 50px;">城市名</div>
    <input id="txt" />

    <div id="overview"></div>

    <div id="map" src="">

   
        <script>
        
            var format = 'image/png';
            var bounds = [73.2516098022461, 15.5910949707031, 135.080017089844, 53.7497673034668];//范围
            

            /*设置各个图层*/

            //居民地地图
            var ImageMap = new ol.layer.Image({
                source: new ol.source.ImageWMS({
                    ratio: 1,
                    //自己的服务url
                    url: 'http://localhost:8080/geoserver/postgis_llw/wms',
                    //设置服务参数
                    params: {
                        'FORMAT': format,
                        'VERSION': '1.1.0',
                        STYLES: '',
                        //图层信息
                        LAYERS: 'postgis_llw:res2_4m',
                    }
                })
            });

            //居民地数据
            var ImageData = new ol.layer.Vector({
                source: new ol.source.Vector({
                    format: new ol.format.GeoJSON(),
                    url: 'http://localhost:8080/geoserver/postgis_llw/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=postgis_llw:res2_4m&maxFeatures=500&outputFormat=json',
                })
            });

            //底图
            var BaseMap = new ol.layer.Tile({
                source: new ol.source.OSM()
            });

            //绘制图层
            var source = ImageData.getSource();

            var vector = new ol.layer.
            Vector({
                source: source
            });


            /*地图的设置*/

            //设置地图投影
            var projection = new ol.proj.Projection({
                code: 'EPSG:4326',//投影编码
                units: 'degrees',
                axisOrientation: 'neu'
            });


            //设置地图
            var map = new ol.Map({
                //地图中的比例尺等控制要素
                controls: ol.control.defaults({
                    attribution: false,
                    rotate: false,
                    zoom: false
                }).extend([
                    new ol.control.ScaleLine()
                ]),
                //设置显示的容器
                target: 'map',
                //设置图层
                layers: [
                    //添加图层
                   BaseMap,
                   //ImageMap,
                   vector,
                   ImageData,
                ],
                //设置视图
                view: new ol.View({
                    //设置投影
                    loadTilesWhileAnimating: true,

                    projection: projection
                })
            });

            //地图显示
            map.getView().fit(bounds, map.getSize());

            //查询
            function btn1_click() {
                var cityid;
                var cityname = document.getElementById("txt").value;
                $.ajax({
                    url: "./x.ashx?cityname=" + cityname,
                    success: function (result) {
                        //alert(result);
                        cityid = result.split(',')[0];
                        //cityid = cityid[0];

                        var source = ImageData.getSource();
                        var feature_id = "res2_4m." + cityid;
                        var feature_pt = source.getFeatureById(feature_id);

                        var x = feature_pt.getCoordinates();
                        var lon = feature_pt.getCoordinates()[0];
                        var lat = feature_pt.getCoordinates()[1];
                        var adclass = feature_pt.getProperties();
                        alert(lon + "," + lat + "," + adclass)

                        var new_style = new ol.style.Style({
                            fill: new ol.style.Fill({ color: 'rgba(160,160,160,5)' }),
                            stroke: new ol.style.Stroke({
                                color: 'black', width: 5
                            })
                        });

                        feature_pt.setStyle(new_style);



                    }
                })
                

            }


            /*设置缩略地图*/

            //定义缩略地图
            var overview = new ol.Map({
                controls: ol.control.defaults({
                    attribution: false,
                    rotate: false,
                    zoom: false
                }).extend([
                    new ol.control.ScaleLine()
                ]),
                target: 'overview',
                layers: [BaseMap],
                view: new ol.View({
                projection: 'EPSG:4326',
                center: map.getView().getCenter(),
                zoom: map.getView().getZoom() - 2,
                //maxZoom: 11,
                //minZoom: 11
              
                })
            });

            //在缩略图中添加map的extent框
            var extent = map.getView().calculateExtent(map.getSize());
            var coor = [[[extent[0], extent[1]], [extent[2], extent[1]], [extent[2], extent[3]], [extent[0], extent[3]], [extent[0], extent[1]]]];
            var polygonFeature = new ol.Feature(new ol.geom.Polygon(coor));

            var vectorSource = new ol.source.Vector({
                features: [polygonFeature]
            });

            var vectorLayer = new ol.layer.Vector({
                source: vectorSource,
                style: new ol.style.Style({
                    fill: new ol.style.Fill({ color: 'rgba(160,160,160,0.2)' }),
                    stroke: new ol.style.Stroke({
                        color: 'white', width: 2
                    })
                })
            });
            overview.addLayer(vectorLayer);

            //设置map和overview互相联动
            map.on('moveend', function () {
                var extent = map.getView().calculateExtent(map.getSize());
                var coor = [[[extent[0], extent[1]], [extent[2], extent[1]], [extent[2], extent[3]], [extent[0], extent[3]], [extent[0], extent[1]]]];
                vectorLayer.getSource().getFeatures()[0].getGeometry().setCoordinates(coor);
                setTimeout(function () {
                    var view = overview.getView();
                    var pan = ol.animation.pan({
                        duration: 250,
                        source: (view.getCenter())
                    });
                    overview.beforeRender(pan);
                    overview.getView().setZoom(map.getView().getZoom() - 2);
                    overview.getView().setCenter(map.getView().getCenter());
                }, 300);
            })

            overview.on('pointermove', function (evt) {
                overview.getTargetElement().style.cursor = 'pointer';
            });

            overview.on('click', function (e) {
                var coor = e.coordinate;
                map.getView().setCenter(coor);
            })


            /*地图的操作*/

            //地图的移动-mapCenter[0]代表x坐标，mapCenter[1]代表y坐标
            //移动到右边
            function moveToRight() {
                var view = map.getView();
                var mapCenter = view.getCenter();
                mapCenter[0] -= 10;
                view.setCenter(mapCenter);
                map.render();
            }

            //移动到左边
            function moveToLeft() {
                var view = map.getView();
                var mapCenter = view.getCenter();
                mapCenter[0] += 10;
                view.setCenter(mapCenter);
                map.render();
            }

            //移动到上边
            function moveToTop() {
                var view = map.getView();
                var mapCenter = view.getCenter();
                mapCenter[1] -= 10;
                view.setCenter(mapCenter);
                map.render();
            }
            //移动到下边
            function moveToBottom() {
                var view = map.getView();
                var mapCenter = view.getCenter();
                mapCenter[1] += 10;
                view.setCenter(mapCenter);
                map.render();
            }


            //地图的放大缩小
            //地图放大
            function zoomIn() {
                var view = map.getView();
                view.setZoom(view.getZoom() + 0.5);
            }
            //地图缩小
            function zoomOut() {
                var view = map.getView();
                view.setZoom(view.getZoom() - 0.5);
            }

            //图层控制
            var tucengkongzhiSelect = document.getElementById('tucengkongzhi');
            tucengkongzhiSelect.onchange = function () {
                var value = tucengkongzhiSelect.value;
                if (value == 'All') {
                    removeAllLayers();
                    map.addLayer(BaseMap);
                    map.addLayer(ImageMap);
                    map.addLayer(ImageData);
                    map.getView().fit(bounds, map.getSize());
                }
                else if (value == 'BaseMap') {
                    removeAllLayers();
                    map.addLayer(BaseMap);
                    map.getView().fit(bounds, map.getSize());
                }
                else if (value == 'ImageMap') {
                    removeAllLayers();
                    map.addLayer(ImageMap);
                    map.getView().fit(bounds, map.getSize());
                }
                else if (value == 'ImageData') {
                    removeAllLayers();
                    map.addLayer(ImageData);
                    map.getView().fit(bounds, map.getSize());
                }
                else if (value == 'Remove') {
                    removeAllLayers();
                }
            }

            function removeAllLayers() {
                for (var i = 0; i < map.getLayers().getLength() ; i++) {
                    map.removeLayer(map.getLayers()[i]);
                }
            }

            /*用户操作*/

            //添加点、线、区域
            var raster = new ol.layer.Tile({
                source: new ol.source.OSM()
            });

            var huizhiSelect = document.getElementById('huizhi');
            //var features = new ol.Collection();
            var features = source.getFeatures();

            var measurePtsArray = new ol.Collection();

            var featureLat, featureLon;

            var draw; // global so we can remove it later
            function addInteraction() {
                var value = huizhiSelect.value;
                if (value !== 'None') {
                    draw = new ol.interaction.Draw({
                        features: source.getFeatures(),
                        source: source,
                        type: /** @type {ol.geom.GeometryType} */ (huizhiSelect.value)
                    });

                    //添加结束
                    draw.on('drawend', function (e) {
                        var currentFeature = e.feature;
                        var coor = currentFeature.getGeometry().getCoordinates();
                        featureLat = coor[0];
                        featureLon = coor[1];

                                                                       
                        //将添加的点传入数据库
                        alert("请输入添加点信息");
                        document.getElementById("cityname").style.zIndex = 100;
                        document.getElementById("citypinyin").style.zIndex = 100;
                        document.getElementById("cityclass").style.zIndex = 100;                       
                        document.getElementById("sure").style.zIndex = 100;
                        document.getElementById("tip").style.zIndex = 100;
                        

                       
                    })

                    map.addInteraction(draw);
                }
            }

            function inputvar() {
                var cityname = document.getElementById("cityname").value;
                var citypinyin = document.getElementById("citypinyin").value;
                var cityclass = document.getElementById("cityclass").value;

                inputvarClick(featureLat, featureLon,cityname,citypinyin,cityclass);
            }

            function inputvarClick(lat,lon,cityname,citypinyin,cityclass) {
                $.ajax({
                    url: "./AddPoint.ashx?lat=" + lat + "&lon=" + lon+"&cityname="+cityname+"&citypinyin="+citypinyin+"&cityclass="+cityclass,
                    success: function (result) {
                        document.getElementById("cityname").style.zIndex = -300;
                        document.getElementById("citypinyin").style.zIndex = -300;
                        document.getElementById("cityclass").style.zIndex = -300;                      
                        document.getElementById("sure").style.zIndex = -300;
                        document.getElementById("tip").style.zIndex = -300;
                        alert("添加成功");
                    }
                })
            }

            huizhiSelect.onchange = function () {
                map.removeInteraction(draw);
                addInteraction();
            };

            addInteraction();


            //修改
            var xiugaiSelect = document.getElementById('xiugai');

            var modify; // global so we can remove it later
            function addInteractionMod() {
                var value = xiugaiSelect.value;
                if (value !== 'None') {
                    modify = new ol.interaction.Modify({
                        features: source.getFeatures(),
                        source: source,
                        type: /** @type {ol.geom.GeometryType} */ (xiugaiSelect.value)
                    });
                    map.addInteraction(modify);
                }
            }

            xiugaiSelect.onchange = function () {
                map.removeInteraction(modify);
                map.removeInteraction(draw);
                addInteractionMod();
            };

            addInteractionMod();
          

            //删除
            var dianxuanSelect = document.getElementById('dianxuan');
            var select = null;
            function addInteractionSel() {
                value = dianxuanSelect.value;
                if (value !== 'None') {
                    select = new ol.interaction.Select();

                    select.on('select', function (e) {
                        var features = e.target.getFeatures();
                        var feature = features.pop();
                        var ptId = feature.getId();
                        ptId = ptId.split('.')[1];
                        alert(ptId);
                        $.ajax({
                            url: "./DeletePoint.ashx?id=" + ptId,
                            success: function (result) {
                                alert("删除成功");
                                
                            }

                        })

                        window.location.reload();

                 
                        var geo = feature.getGeometry();
                        var coor = geo.getCoordinates();
                        var latitude = coor[0];
                        var lontitude = coor[1];
                        var location = ol.proj.fromLonLat(coor);
                        var viewx = map.getView();
                        viewx.animate({
                            center: location,
                            duration: 2000
                        });

                    });
                    map.addInteraction(select);
                }
            }

            dianxuanSelect.onchange = function () {
                map.removeInteraction(modify);
                map.removeInteraction(draw);
                addInteractionSel();
            };

            addInteractionSel();
           

            //量测
            var measureFeature;
            var drawM = new ol.interaction.Draw({
                //在一个暂时的图层进行量算操作
                features: measureFeature,
                source: vector.getSource(),
                type: 'Point',
            })

            //选择完两个点之后,进行距离的计算
            drawM.on('drawend', function (e) {
                var currentFeature = e.feature;
                measureFeature.push(currentFeature);
                if (measureFeature.getLength() == 2) {
                    var firstFeature = measureFeature.removeAt(0);
                    var wgs84Sphere = new ol.Sphere(6378137);
                    var distance = wgs84Sphere.haversineDistance(firstFeature.getGeometry().getCoordinates(), currentFeature.getGeometry().getCoordinates());
                    alert("两点距离为" + parseInt(distance) + "m");
                }
            })

            var judgeMeasure = false;

            //点击距离量算按钮后,添加距离量算的交互,删除其他的交互
            function measureBtn() {
                if (!judgeMeasure) {
                    measureFeature = new ol.Collection();
                    map.addInteraction(drawM);
                }
                else {
                    map.removeInteraction(drawM);
                }
                judgeMeasure = !judgeMeasure;
            }

            //导出地图
            function exportmap() {
                map.once('postcompose', function (event) {
                    var canvas = event.context.canvas;
                    canvas.toBlob(function (blob) {
                        saveAs(blob, 'map.png');
                    });
                });
                map.renderSync();
            };


            //打开浮动界面
            function query_chart() {
                if (document.getElementById("float").style.display == "none") {
                    document.getElementById("float").style.display = "";
                    //画图
                    draw_chart();
                }

                else {
                    document.getElementById("float").style.display = "none";
                }
            }

            //绘制图表
            function draw_chart() {

                var classArray = [];//class数组
                var countArray = [];//个数数组
                $.ajax({
                    url: "./DrawChart.ashx",
                    success: function (result) {
                        //读取数据
                        var all_data = result.split('\n');
                        for (var i = 0; i < all_data.length - 1; i++) {
                            var class_value = all_data[i].split(',')[0];
                            var count_value = all_data[i].split(',')[1];
                            classArray.push(class_value);
                            countArray.push(count_value);
                        }
                        drawChart(classArray, countArray);
                    }
                })
            }
           

            function drawChart(array1,array2) {
                // 基于准备好的dom，初始化echarts实例
                var myChart = echarts.init(document.getElementById('mainchart'));
                // 指定图表的配置项和数据
                var option = {
                    //title: {
                    //    text: title_text
                    //},
                    tooltip: {},
                    legend: {
                        data: ['个数']
                    },

                    xAxis: {
                        data: array1
                    },

                    yAxis: {},
                    series: [{
                        name: '个数',
                        type: 'bar',
                        data: array2 //[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2000, 3000] //distanceArray,
                    }]
                };
                // 使用刚指定的配置项和数据显示图表。
                myChart.setOption(option);
            }

        </script>
    </div>

</body>

</html>
